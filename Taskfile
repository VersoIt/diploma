version: '3'

tasks:
  test:
    desc: Run all tests
    cmds:
      - go test -v ./...

  lint:
    desc: Run linter
    cmds:
      - golangci-lint run

  proto:
    desc: Generate Go code from proto files in all services
    cmds:
      # Create target directories
      - powershell -Command "New-Item -ItemType Directory -Force services/orders/pkg/api/proto, services/catalog/pkg/api/proto, services/auth/pkg/api/proto, services/analytics/pkg/api/proto, services/kitchen/pkg/api/proto, services/logistics/pkg/api/proto, services/notification/pkg/api/proto, services/treasury/pkg/api/proto"
      # Generate from each service
      - protoc --proto_path=. --go_out=. --go_opt=paths=import services/orders/api/proto/*.proto
      - protoc --proto_path=. --go_out=. --go_opt=paths=import services/catalog/api/proto/*.proto
      - protoc --proto_path=. --go_out=. --go_opt=paths=import services/auth/api/proto/*.proto
      - protoc --proto_path=. --go_out=. --go_opt=paths=import services/analytics/api/proto/*.proto
      - protoc --proto_path=. --go_out=. --go_opt=paths=import services/kitchen/api/proto/*.proto
      - protoc --proto_path=. --go_out=. --go_opt=paths=import services/logistics/api/proto/*.proto
      - protoc --proto_path=. --go_out=. --go_opt=paths=import services/notification/api/proto/*.proto
      - protoc --proto_path=. --go_out=. --go_opt=paths=import services/treasury/api/proto/*.proto

  docker-up:
    desc: Run infrastructure via docker-compose
    cmds:
      - docker-compose up --build -d

  docker-down:
    desc: Stop docker-compose
    cmds:
      - docker-compose down

  k8s-deploy:
    desc: Deploy all services to Kubernetes
    cmds:
      - kubectl apply -f deploy/k8s/namespace.yaml
      - kubectl apply -f deploy/k8s/
    
  k8s-undeploy:
    desc: Remove all services from Kubernetes
    cmds:
      - kubectl delete -f deploy/k8s/